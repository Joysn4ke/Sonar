/**
  ******************************************************************************
  * @file    apds9960_demoRGB
  * @author  Cécile Lebrun
  * @version V1.0
  * @date    26-Janvier-2017
  * @brief   Fichier exemple de l'utilisation du capteur APDS9960 en mode capteur de luminosité. Il permet,
  *			 lors de l'appui sur le bouton bleu de la Nucleo, de lire la valeur de la luminosité et de
  *			 ses composantes RGB avant de les afficher sur l'UART.
  *
  ******************************************************************************
*/
#include "stm32f1xx_hal.h"
#include "stm32f1xx_nucleo.h"
#include "stm32f1_uart.h"
#include "stm32f1_sys.h"
#include "macro_types.h"
#include "stm32f1_gpio.h"
#include "APDS9960/apds9960.h"


int main(void)
{
	HAL_Init();			//Initialisation de la couche logicielle HAL (Hardware Abstraction Layer)
	BSP_GPIO_Enable();	//Activation des périphériques GPIO
	SYS_ClockConfig();		//Configuration des horloges.

	//Initialisation du port du bouton bleu (carte Nucleo)
	BSP_GPIO_PinCfg(BLUE_BUTTON_GPIO, BLUE_BUTTON_PIN, GPIO_MODE_INPUT,GPIO_NOPULL,GPIO_SPEED_FREQ_HIGH);

	//Initialisation de l'UART1 à la vitesse de 115200 bauds/secondes (92kbits/s) PB6 : Tx  | PB7 : Rx.
	UART_init(UART1_ID,115200);

	//"Indique que les printf sortent vers le périphérique UART1."
	SYS_set_std_usart(UART1_ID, UART1_ID, UART1_ID);

	//Initialisation du capteur.
	init();
	
	int boutonAppuye = 0;
	
	//Activation du capteur en mode capteur de luminosité.
	enableLightSensor(FALSE);
	
	//Variables de stockage des niveau de lumière trouvés.
	uint16_t ambientLight = 0;
	uint16_t redLight = 0;
	uint16_t blueLight = 0;
	uint16_t greenLight = 0;


	while(1)
	{
		//Quand on appuie sur le bouton bleu
		if(HAL_GPIO_ReadPin(BLUE_BUTTON_GPIO, BLUE_BUTTON_PIN))
			boutonAppuye = 1;
		else
			if (boutonAppuye)
			{
				boutonAppuye = 0;
				
				//On lit les différentes luminosités...
				readAmbientLight(&ambientLight);
				readRedLight(&redLight);
				readBlueLight(&blueLight);
				readGreenLight(&greenLight);
				
				//... Puis on les affiche sur l'uart.
				printf("\n\nAmbient Light : %d lux", ambientLight/10);
				printf("\nRed Light Level : %d", redLight);
				printf("\nBlue Light Level : %d", blueLight);
				printf("\nGreen Light Level : %d\n", greenLight);
				
				HAL_Delay(500);
			}
	}
}






