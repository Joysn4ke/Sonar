/**
  ******************************************************************************
  * @file    main.c
  * @author  Ac6
  * @version V1.0
  * @date    01-December-2013
  * @brief   Default main function.
  ******************************************************************************
*/
#include "stm32f1xx_hal.h"
#include "stm32f1xx_nucleo.h"
#include "stm32f1_uart.h"
#include "stm32f1_sys.h"
#include "macro_types.h"
#include "stm32f1_gpio.h"

/* Includes ------------------------------------------------------------------*/
#include "../lib/bsp/NFC03A1/Examples/nfc03a1.h"

/* Public Variables-----------------------------------------------------------*/
extern DeviceMode_t devicemode;


int main(void)
{
	int8_t TagType = TRACK_NOTHING;
	bool TagDetected = false;
	bool terminal_msg_flag = false;
	static char dataOut[COM_XFER_SIZE];

	NFC03A1_Init();
	NFC03A1_DisplayMenu();

	terminal_msg_flag = true;

//	HAL_Init();			//Initialisation de la couche logicielle HAL (Hardware Abstraction Layer)
//	BSP_GPIO_Enable();	//Activation des périphériques GPIO
//	SYS_ClockConfig();		//Configuration des horloges.

//	//Initialisation du port de la led Verte (carte Nucleo)
//	BSP_GPIO_PinCfg(LED_GREEN_GPIO, LED_GREEN_PIN, GPIO_MODE_OUTPUT_PP,GPIO_PULLUP,GPIO_SPEED_FREQ_HIGH);
//
//	//Initialisation du port du bouton bleu (carte Nucleo)
//	BSP_GPIO_PinCfg(BLUE_BUTTON_GPIO, BLUE_BUTTON_PIN, GPIO_MODE_INPUT,GPIO_NOPULL,GPIO_SPEED_FREQ_HIGH);
//
//	//Initialisation de l'UART1 à la vitesse de 115200 bauds/secondes (92kbits/s) PB6 : Tx  | PB7 : Rx.
//	UART_init(UART1_ID,115200);
//
//	//"Indique que les printf sortent vers le périphérique UART1."
//	SYS_set_std_usart(UART1_ID, UART1_ID, UART1_ID);

	while(1)
	{
		devicemode = PCD;

	    /* Scan to find if there is a tag */
	    TagType = ConfigManager_TagHunting(TRACK_ALL);

	    /*
	     * Si on détecte une carte étudiante (tag de type 4A),
	     * on récupère son identifiant et on l'affiche.
	     */
	    if(TagType == TRACK_NFCTYPE4A) {
	    	TagDetected = true;
	    	LED_Off(GREEN_LED1);
	    	LED_On(BLUE_LED4);

	    	int j = 0;
	    	uint8_t* ptr = getUID();
	    	/*
	    	 * Récupération de la taille de l'ID
	    	 */
	    	uint8_t size = *(ptr);
	    	uint8_t tab[size];
	    	char src[50], dest[50];

    		strcpy(dest, "UID = ");

			/*
			 * Concaténation des différents numéros de l'ID dans une même chaîne
			 * afin de pour les afficher par la suite.
			 */
	    	for (j = 0; j < size; j++) {
	    		tab[j] = *(ptr+j+1);
	    		sprintf(dataOut, "%u ", tab[j]);
	    		strcpy(src, dataOut);
	    		strcat(dest, src);
			}
	    	if (terminal_msg_flag == true) {
	    		terminal_msg_flag = false;
	    		sprintf( dataOut, "\n\n%s", dest);
	    		HAL_UART_Transmit( &UartHandle, ( uint8_t * )dataOut, strlen( dataOut ), 500 );
	    	}
	    }
	    else {
	    	TagDetected = false;
	    	LED_Off(BLUE_LED2);
	    	LED_Off(GREEN_LED3);
	    	LED_Off(BLUE_LED4);
	    	LED_Toggle(GREEN_LED1);
			if(terminal_msg_flag == false) {
				terminal_msg_flag = true ;
				sprintf( dataOut, "\n\nCurrently there is no NFC tag in the vicinity");
				HAL_UART_Transmit( &UartHandle, ( uint8_t * )dataOut, strlen( dataOut ), 500 );
			}
	    }
	    HAL_Delay(300);
	}
}

